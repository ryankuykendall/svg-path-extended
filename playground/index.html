<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>svg-path-extended Playground</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      --bg-primary: #ffffff;
      --bg-secondary: #f5f5f5;
      --bg-tertiary: #e8e8e8;
      --text-primary: #1a1a1a;
      --text-secondary: #666666;
      --border-color: #ddd;
      --accent-color: #0066cc;
      --error-bg: #fee;
      --error-text: #c00;
      --success-color: #28a745;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-secondary);
      color: var(--text-primary);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background: var(--bg-primary);
      border-bottom: 1px solid var(--border-color);
      padding: 12px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 12px;
    }

    h1 {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    h1 code {
      font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
      background: var(--bg-secondary);
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 1rem;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .secondary-btn {
      padding: 4px 10px;
      font-size: 0.75rem;
      background: transparent;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.15s;
    }

    .secondary-btn:hover {
      background: var(--bg-secondary);
      color: var(--text-primary);
    }

    .header-controls {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    select, input, button {
      font-family: inherit;
      font-size: 0.875rem;
    }

    select {
      padding: 6px 12px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      background: var(--bg-primary);
      cursor: pointer;
    }

    main {
      flex: 1;
      display: flex;
      gap: 0;
      min-height: 0;
    }

    @media (max-width: 800px) {
      main {
        flex-direction: column;
      }
    }

    #editor-pane {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
      border-right: 1px solid var(--border-color);
      position: relative;
    }

    @media (max-width: 800px) {
      #editor-pane {
        border-right: none;
        border-bottom: 1px solid var(--border-color);
        min-height: 300px;
      }
    }

    #editor-container {
      flex: 1;
      overflow: auto;
    }

    .pane-copy-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      z-index: 10;
      padding: 4px 10px;
      font-size: 0.75rem;
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      cursor: pointer;
      opacity: 0.7;
      transition: opacity 0.15s;
    }

    .pane-copy-btn:hover {
      opacity: 1;
      background: var(--bg-secondary);
    }

    .pane-copy-btn.copied {
      background: var(--success-color);
      border-color: var(--success-color);
      color: white;
      opacity: 1;
    }

    .cm-editor {
      height: 100%;
      font-size: 14px;
    }

    .cm-editor .cm-scroller {
      font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Fira Code', monospace;
    }

    .cm-editor.cm-focused {
      outline: none;
    }

    #preview-pane {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
      background: var(--bg-primary);
      min-width: 0;
      overflow: auto;
      position: relative;
    }

    #preview-container {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #preview {
      display: block;
      max-width: 100%;
      max-height: 100%;
    }

    #error-panel {
      background: var(--error-bg);
      color: var(--error-text);
      padding: 12px 20px;
      font-family: 'SF Mono', Monaco, monospace;
      font-size: 0.875rem;
      border-top: 1px solid #fcc;
      display: none;
    }

    #error-panel.visible {
      display: block;
    }

    footer {
      background: var(--bg-primary);
      border-top: 1px solid var(--border-color);
      padding: 12px 20px;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 16px;
    }

    .control-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .control-group label {
      font-size: 0.8125rem;
      color: var(--text-secondary);
      white-space: nowrap;
    }

    input[type="number"] {
      width: 70px;
      padding: 6px 8px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
    }

    input[type="color"] {
      width: 36px;
      height: 30px;
      padding: 2px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      cursor: pointer;
    }

    input[type="checkbox"] {
      width: 16px;
      height: 16px;
      cursor: pointer;
    }

    .control-group select {
      min-width: 60px;
    }

    button {
      padding: 6px 16px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      background: var(--bg-primary);
      cursor: pointer;
      transition: background 0.15s;
    }

    button:hover {
      background: var(--bg-secondary);
    }

    button.primary {
      background: var(--accent-color);
      color: white;
      border-color: var(--accent-color);
    }

    button.primary:hover {
      background: #0052a3;
    }

    #copy-feedback {
      font-size: 0.75rem;
      color: var(--success-color);
      opacity: 0;
      transition: opacity 0.2s;
    }

    #copy-feedback.visible {
      opacity: 1;
    }

    .spacer {
      flex: 1;
    }

    .links {
      font-size: 0.8125rem;
    }

    .links a {
      color: var(--accent-color);
      text-decoration: none;
    }

    .links a:hover {
      text-decoration: underline;
    }

    /* Docs Panel */
    #docs-panel {
      position: fixed;
      top: 0;
      right: 0;
      width: 420px;
      max-width: 100vw;
      height: 100vh;
      background: var(--bg-primary);
      border-left: 1px solid var(--border-color);
      box-shadow: -4px 0 20px rgba(0, 0, 0, 0.1);
      transform: translateX(100%);
      transition: transform 0.3s ease;
      z-index: 1000;
      display: flex;
      flex-direction: column;
    }

    #docs-panel.open {
      transform: translateX(0);
    }

    #docs-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      border-bottom: 1px solid var(--border-color);
      background: var(--bg-secondary);
    }

    #docs-header h2 {
      font-size: 1rem;
      font-weight: 600;
      margin: 0;
    }

    #docs-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      padding: 4px 8px;
      color: var(--text-secondary);
      line-height: 1;
    }

    #docs-close:hover {
      color: var(--text-primary);
      background: var(--bg-tertiary);
    }

    #docs-tabs {
      display: flex;
      border-bottom: 1px solid var(--border-color);
    }

    .docs-tab {
      flex: 1;
      padding: 10px 16px;
      border: none;
      background: var(--bg-secondary);
      cursor: pointer;
      font-size: 0.875rem;
      color: var(--text-secondary);
      border-bottom: 2px solid transparent;
      transition: all 0.15s;
    }

    .docs-tab:hover {
      background: var(--bg-tertiary);
    }

    .docs-tab.active {
      background: var(--bg-primary);
      color: var(--accent-color);
      border-bottom-color: var(--accent-color);
    }

    #docs-content {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }

    #docs-content h3 {
      font-size: 1rem;
      font-weight: 600;
      margin: 20px 0 10px 0;
      color: var(--text-primary);
    }

    #docs-content h3:first-child {
      margin-top: 0;
    }

    #docs-content h4 {
      font-size: 0.875rem;
      font-weight: 600;
      margin: 16px 0 8px 0;
      color: var(--text-primary);
    }

    #docs-content p {
      font-size: 0.8125rem;
      line-height: 1.5;
      color: var(--text-secondary);
      margin: 8px 0;
    }

    #docs-content code {
      font-family: 'SF Mono', Monaco, monospace;
      font-size: 0.75rem;
      background: var(--bg-secondary);
      padding: 2px 5px;
      border-radius: 3px;
    }

    #docs-content pre {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 12px;
      border-radius: 6px;
      overflow-x: auto;
      font-size: 0.75rem;
      line-height: 1.5;
      margin: 10px 0;
    }

    #docs-content pre code {
      background: none;
      padding: 0;
      color: inherit;
    }

    #docs-content table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.75rem;
      margin: 10px 0;
    }

    #docs-content th, #docs-content td {
      text-align: left;
      padding: 6px 8px;
      border-bottom: 1px solid var(--border-color);
    }

    #docs-content th {
      background: var(--bg-secondary);
      font-weight: 600;
    }

    .doc-section {
      display: none;
    }

    .doc-section.active {
      display: block;
    }

    /* Annotated Panel */
    #annotated-pane {
      flex: 0 0 0;
      display: flex;
      flex-direction: column;
      min-width: 0;
      border-right: 1px solid var(--border-color);
      position: relative;
      overflow: hidden;
      transition: flex-basis 0.3s ease;
    }

    #annotated-pane.open {
      flex: 1 1 0;
    }

    #annotated-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 12px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-color);
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    #annotated-header span {
      font-weight: 500;
    }

    #annotated-container {
      flex: 1;
      overflow: auto;
      background: var(--bg-primary);
    }

    #annotated-container .cm-editor {
      height: 100%;
      font-size: 13px;
      background: var(--bg-primary);
    }

    #annotated-container .cm-editor .cm-content {
      cursor: default;
    }

    /* Annotated toggle button */
    #annotated-toggle {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      font-size: 0.75rem;
      background: transparent;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.15s;
    }

    #annotated-toggle:hover {
      background: var(--bg-secondary);
      color: var(--text-primary);
    }

    #annotated-toggle.active {
      background: var(--accent-color);
      border-color: var(--accent-color);
      color: white;
    }

    #annotated-toggle .toggle-icon {
      font-size: 0.875rem;
      transition: transform 0.2s;
    }

    #annotated-toggle.active .toggle-icon {
      transform: rotate(180deg);
    }

    @media (max-width: 800px) {
      #annotated-pane {
        flex-basis: 0;
        border-right: none;
        border-bottom: 1px solid var(--border-color);
      }

      #annotated-pane.open {
        flex: 0 0 200px;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-left">
      <h1><code>svg-path-extended</code> Playground</h1>
      <button id="annotated-toggle" title="Show annotated output">
        <span class="toggle-icon">&#9654;</span>
        Annotated
      </button>
      <button id="copy-url" class="secondary-btn">Copy URL</button>
      <span id="copy-feedback">Copied!</span>
    </div>
    <div class="header-controls">
      <label for="examples">Examples:</label>
      <select id="examples">
        <option value="">-- Select --</option>
        <option value="circle">Circle</option>
        <option value="star">Star</option>
        <option value="grid">Grid of Dots</option>
        <option value="spiral">Spiral</option>
        <option value="flower">Flower</option>
        <option value="sineWave">Sine Wave</option>
        <option value="gear">Gear</option>
        <option value="customFunction">Custom Function</option>
      </select>
    </div>
  </header>

  <main>
    <div id="editor-pane">
      <button id="copy-code" class="pane-copy-btn">Copy Code</button>
      <div id="editor-container"></div>
    </div>
    <div id="annotated-pane">
      <div id="annotated-header">
        <span>Annotated Output</span>
        <button id="copy-annotated" class="pane-copy-btn" style="position: static; opacity: 1;">Copy</button>
      </div>
      <div id="annotated-container"></div>
    </div>
    <div id="preview-pane">
      <button id="copy-svg" class="pane-copy-btn">Copy SVG</button>
      <div id="preview-container">
        <svg id="preview" xmlns="http://www.w3.org/2000/svg">
          <defs>
            <pattern id="grid-pattern" patternUnits="userSpaceOnUse">
              <path id="grid-path" fill="none" stroke-width="0.5"/>
            </pattern>
          </defs>
          <rect id="preview-bg" width="100%" height="100%"></rect>
          <rect id="preview-grid" width="100%" height="100%" fill="url(#grid-pattern)"></rect>
          <path id="preview-path" fill="none"></path>
        </svg>
      </div>
    </div>
  </main>

  <div id="error-panel"></div>

  <!-- Documentation Panel -->
  <div id="docs-panel">
    <div id="docs-header">
      <h2>Documentation</h2>
      <button id="docs-close">&times;</button>
    </div>
    <div id="docs-tabs">
      <button class="docs-tab active" data-tab="syntax">Syntax</button>
      <button class="docs-tab" data-tab="stdlib">Stdlib</button>
    </div>
    <div id="docs-content">
      <!-- Syntax Tab -->
      <div class="doc-section active" id="doc-syntax">
        <h3>Path Commands</h3>
        <table>
          <tr><th>Command</th><th>Name</th><th>Parameters</th></tr>
          <tr><td><code>M</code> / <code>m</code></td><td>Move to</td><td>x y</td></tr>
          <tr><td><code>L</code> / <code>l</code></td><td>Line to</td><td>x y</td></tr>
          <tr><td><code>H</code> / <code>h</code></td><td>Horizontal line</td><td>x</td></tr>
          <tr><td><code>V</code> / <code>v</code></td><td>Vertical line</td><td>y</td></tr>
          <tr><td><code>C</code> / <code>c</code></td><td>Cubic bezier</td><td>x1 y1 x2 y2 x y</td></tr>
          <tr><td><code>Q</code> / <code>q</code></td><td>Quadratic bezier</td><td>x1 y1 x y</td></tr>
          <tr><td><code>A</code> / <code>a</code></td><td>Arc</td><td>rx ry rot large sweep x y</td></tr>
          <tr><td><code>Z</code> / <code>z</code></td><td>Close path</td><td>(none)</td></tr>
        </table>

        <h3>Variables</h3>
        <p>Declare variables with <code>let</code>:</p>
        <pre><code>let width = 200;
let centerX = 100;
M centerX 50</code></pre>

        <h3>Expressions with calc()</h3>
        <p>Use <code>calc()</code> for math expressions:</p>
        <pre><code>let r = 50;
M calc(100 - r) 100
L calc(100 + r) 100</code></pre>

        <h4>Operators</h4>
        <table>
          <tr><td><code>+</code> <code>-</code> <code>*</code> <code>/</code> <code>%</code></td><td>Arithmetic</td></tr>
          <tr><td><code>&lt;</code> <code>&gt;</code> <code>&lt;=</code> <code>&gt;=</code> <code>==</code> <code>!=</code></td><td>Comparison</td></tr>
          <tr><td><code>&&</code> <code>||</code> <code>!</code></td><td>Logical</td></tr>
        </table>

        <h3>For Loops</h3>
        <pre><code>for (i in 0..10) {
  L calc(i * 20) calc(i * 10)
}</code></pre>
        <p>Range <code>0..10</code> includes 0-9 (exclusive end).</p>

        <h3>Conditionals</h3>
        <pre><code>if (size > 50) {
  circle(100, 100, size)
} else {
  rect(50, 50, 100, 100)
}</code></pre>

        <h3>Functions</h3>
        <pre><code>fn square(x, y, size) {
  rect(x, y, size, size)
}

square(10, 10, 50)</code></pre>

        <h3>Comments</h3>
        <pre><code>// This is a comment
let x = 50;  // inline comment</code></pre>
      </div>

      <!-- Stdlib Tab -->
      <div class="doc-section" id="doc-stdlib">
        <h3>Math Functions</h3>

        <h4>Trigonometry</h4>
        <p><code>sin(x)</code> <code>cos(x)</code> <code>tan(x)</code> <code>asin(x)</code> <code>acos(x)</code> <code>atan(x)</code> <code>atan2(y, x)</code></p>

        <h4>Angle Conversion</h4>
        <p><code>rad(degrees)</code> <code>deg(radians)</code></p>

        <h4>Exponential</h4>
        <p><code>exp(x)</code> <code>log(x)</code> <code>log10(x)</code> <code>pow(x, y)</code> <code>sqrt(x)</code> <code>cbrt(x)</code></p>

        <h4>Rounding</h4>
        <p><code>floor(x)</code> <code>ceil(x)</code> <code>round(x)</code> <code>trunc(x)</code></p>

        <h4>Utility</h4>
        <p><code>abs(x)</code> <code>sign(x)</code> <code>min(a, b)</code> <code>max(a, b)</code></p>

        <h4>Interpolation</h4>
        <table>
          <tr><td><code>lerp(a, b, t)</code></td><td>Linear interpolation</td></tr>
          <tr><td><code>clamp(val, min, max)</code></td><td>Constrain to range</td></tr>
          <tr><td><code>map(val, inMin, inMax, outMin, outMax)</code></td><td>Map between ranges</td></tr>
        </table>

        <h4>Constants</h4>
        <p><code>PI()</code> <code>E()</code> <code>TAU()</code></p>

        <h4>Random</h4>
        <p><code>random()</code> <code>randomRange(min, max)</code></p>

        <h3>Path Functions</h3>

        <h4>Shapes</h4>
        <table>
          <tr><td><code>circle(cx, cy, r)</code></td><td>Circle</td></tr>
          <tr><td><code>rect(x, y, w, h)</code></td><td>Rectangle</td></tr>
          <tr><td><code>roundRect(x, y, w, h, r)</code></td><td>Rounded rectangle</td></tr>
          <tr><td><code>polygon(cx, cy, r, sides)</code></td><td>Regular polygon</td></tr>
          <tr><td><code>star(cx, cy, outer, inner, points)</code></td><td>Star shape</td></tr>
        </table>

        <h4>Curves</h4>
        <table>
          <tr><td><code>line(x1, y1, x2, y2)</code></td><td>Line segment</td></tr>
          <tr><td><code>arc(rx, ry, rot, lg, sw, x, y)</code></td><td>Arc</td></tr>
          <tr><td><code>quadratic(x1, y1, cx, cy, x2, y2)</code></td><td>Quadratic bezier</td></tr>
          <tr><td><code>cubic(x1, y1, c1x, c1y, c2x, c2y, x2, y2)</code></td><td>Cubic bezier</td></tr>
        </table>

        <h4>Commands</h4>
        <p><code>moveTo(x, y)</code> <code>lineTo(x, y)</code> <code>closePath()</code></p>

        <h3>Example</h3>
        <pre><code>// 8 points around a circle
let cx = 100;
let cy = 100;
let r = 60;

for (i in 0..7) {
  let angle = calc(i / 8 * TAU());
  let x = calc(cx + cos(angle) * r);
  let y = calc(cy + sin(angle) * r);
  circle(x, y, 5)
}</code></pre>
      </div>
    </div>
  </div>

  <footer>
    <div class="control-group">
      <label for="width">Width:</label>
      <input type="number" id="width" value="200" min="50" max="1000">
    </div>
    <div class="control-group">
      <label for="height">Height:</label>
      <input type="number" id="height" value="200" min="50" max="1000">
    </div>
    <div class="control-group">
      <label for="stroke">Stroke:</label>
      <input type="color" id="stroke" value="#000000">
    </div>
    <div class="control-group">
      <label for="fill-enabled">Fill:</label>
      <input type="checkbox" id="fill-enabled">
      <input type="color" id="fill" value="#3498db" disabled>
    </div>
    <div class="control-group">
      <label for="bg">Background:</label>
      <input type="color" id="bg" value="#f5f5f5">
    </div>
    <div class="control-group">
      <label for="grid-enabled">Grid:</label>
      <input type="checkbox" id="grid-enabled" checked>
      <input type="color" id="grid-color" value="#cccccc">
      <select id="grid-size">
        <option value="10">10px</option>
        <option value="20" selected>20px</option>
        <option value="25">25px</option>
        <option value="50">50px</option>
        <option value="100">100px</option>
      </select>
    </div>
    <div class="control-group">
      <label for="stroke-width">Stroke:</label>
      <select id="stroke-width">
        <option value="1">1px</option>
        <option value="2" selected>2px</option>
        <option value="3">3px</option>
        <option value="4">4px</option>
        <option value="5">5px</option>
        <option value="6">6px</option>
        <option value="8">8px</option>
        <option value="10">10px</option>
      </select>
    </div>
    <div class="spacer"></div>
    <button id="docs-btn">Docs</button>
  </footer>

  <!-- CodeMirror 6 from CDN -->
  <script type="module">
    import { EditorState } from 'https://esm.sh/@codemirror/state@6';
    import { EditorView, keymap, lineNumbers, highlightActiveLineGutter, highlightSpecialChars, drawSelection, rectangularSelection, highlightActiveLine } from 'https://esm.sh/@codemirror/view@6';
    import { defaultKeymap, history, historyKeymap, indentWithTab } from 'https://esm.sh/@codemirror/commands@6';
    import { syntaxHighlighting, defaultHighlightStyle, bracketMatching, indentOnInput } from 'https://esm.sh/@codemirror/language@6';
    import { javascript } from 'https://esm.sh/@codemirror/lang-javascript@6';

    // Examples
    const examples = {
      circle: `// Simple circle
circle(100, 100, 50)`,

      star: `// 5-pointed star
let cx = 100;
let cy = 100;
let outerR = 60;
let innerR = 25;
let points = 5;

star(cx, cy, outerR, innerR, points)`,

      grid: `// Grid of dots using nested loops (5x5)
for (row in 0..4) {
  for (col in 0..4) {
    circle(calc(20 + col * 40), calc(20 + row * 40), 5)
  }
}`,

      spiral: `// Spiral using trigonometry
M 100 100
for (i in 1..100) {
  let angle = calc(i * 0.2);
  let r = calc(i * 0.8);
  L calc(100 + cos(angle) * r) calc(100 + sin(angle) * r)
}`,

      flower: `// Flower with petals
let cx = 100;
let cy = 100;
let petalCount = 6;
let petalRadius = 25;
let centerRadius = 15;

// Petals (0 to petalCount-1 for correct count)
for (i in 0..calc(petalCount - 1)) {
  let angle = calc(i / petalCount * TAU());
  let px = calc(cx + cos(angle) * 35);
  let py = calc(cy + sin(angle) * 35);
  circle(px, py, petalRadius)
}

// Center
circle(cx, cy, centerRadius)`,

      sineWave: `// Sine wave
M 0 100
for (i in 1..40) {
  let x = calc(i * 5);
  let y = calc(100 + sin(i * 0.3) * 30);
  L x y
}`,

      gear: `// Gear shape
let cx = 100;
let cy = 100;
let innerR = 30;
let outerR = 50;
let teeth = 12;

M calc(cx + outerR) cy

for (i in 0..calc(teeth - 1)) {
  let a1 = calc(i / teeth * TAU());
  let a2 = calc((i + 0.3) / teeth * TAU());
  let a3 = calc((i + 0.5) / teeth * TAU());
  let a4 = calc((i + 0.8) / teeth * TAU());

  L calc(cx + cos(a1) * outerR) calc(cy + sin(a1) * outerR)
  L calc(cx + cos(a2) * outerR) calc(cy + sin(a2) * outerR)
  L calc(cx + cos(a3) * innerR) calc(cy + sin(a3) * innerR)
  L calc(cx + cos(a4) * innerR) calc(cy + sin(a4) * innerR)
}

Z

// Center hole
circle(cx, cy, 10)`,

      customFunction: `// Custom function: diamond shape
fn diamond(cx, cy, size) {
  M cx calc(cy - size)
  L calc(cx + size) cy
  L cx calc(cy + size)
  L calc(cx - size) cy
  Z
}

// Draw diamonds in a row
for (i in 0..4) {
  diamond(calc(40 + i * 45), 100, 20)
}`
    };

    // Default code
    const defaultCode = `// Welcome to svg-path-extended!
// Try editing this code or select an example above.

let cx = 100;
let cy = 100;

// Draw a circle
circle(cx, cy, 40)

// Draw 8 points around it
for (i in 0..7) {
  let angle = calc(i / 8 * TAU());
  let x = calc(cx + cos(angle) * 70);
  let y = calc(cy + sin(angle) * 70);
  circle(x, y, 8)
}`;

    // DOM elements
    const editorContainer = document.getElementById('editor-container');
    const preview = document.getElementById('preview');
    const previewPath = document.getElementById('preview-path');
    const previewBg = document.getElementById('preview-bg');
    const previewGrid = document.getElementById('preview-grid');
    const gridPattern = document.getElementById('grid-pattern');
    const gridPath = document.getElementById('grid-path');
    const errorPanel = document.getElementById('error-panel');
    const examplesSelect = document.getElementById('examples');
    const widthInput = document.getElementById('width');
    const heightInput = document.getElementById('height');
    const strokeInput = document.getElementById('stroke');
    const fillEnabledInput = document.getElementById('fill-enabled');
    const fillInput = document.getElementById('fill');
    const bgInput = document.getElementById('bg');
    const gridEnabledInput = document.getElementById('grid-enabled');
    const gridColorInput = document.getElementById('grid-color');
    const gridSizeSelect = document.getElementById('grid-size');
    const strokeWidthSelect = document.getElementById('stroke-width');
    const copyUrlBtn = document.getElementById('copy-url');
    const copyFeedback = document.getElementById('copy-feedback');
    const docsBtn = document.getElementById('docs-btn');
    const docsPanel = document.getElementById('docs-panel');
    const docsClose = document.getElementById('docs-close');
    const docsTabs = document.querySelectorAll('.docs-tab');
    const docSections = document.querySelectorAll('.doc-section');
    const copyCodeBtn = document.getElementById('copy-code');
    const copySvgBtn = document.getElementById('copy-svg');
    const annotatedToggle = document.getElementById('annotated-toggle');
    const annotatedPane = document.getElementById('annotated-pane');
    const annotatedContainer = document.getElementById('annotated-container');
    const copyAnnotatedBtn = document.getElementById('copy-annotated');

    // State
    let debounceTimer = null;
    let editor = null;
    let annotatedEditor = null;
    let annotatedPaneOpen = false;

    // Initialize editor
    function createEditor(initialCode) {
      const updateExtension = EditorView.updateListener.of((update) => {
        if (update.docChanged) {
          debouncedUpdate();
        }
      });

      const state = EditorState.create({
        doc: initialCode,
        extensions: [
          lineNumbers(),
          highlightActiveLineGutter(),
          highlightSpecialChars(),
          history(),
          drawSelection(),
          rectangularSelection(),
          highlightActiveLine(),
          indentOnInput(),
          bracketMatching(),
          syntaxHighlighting(defaultHighlightStyle),
          javascript(),
          keymap.of([
            ...defaultKeymap,
            ...historyKeymap,
            indentWithTab,
          ]),
          updateExtension,
          EditorView.lineWrapping,
        ],
      });

      return new EditorView({
        state,
        parent: editorContainer,
      });
    }

    // Create read-only editor for annotated output
    function createAnnotatedEditor() {
      const state = EditorState.create({
        doc: '// Click "Annotated" to view debug output',
        extensions: [
          lineNumbers(),
          highlightSpecialChars(),
          drawSelection(),
          highlightActiveLine(),
          syntaxHighlighting(defaultHighlightStyle),
          javascript(),
          EditorView.lineWrapping,
          EditorState.readOnly.of(true),
          EditorView.editable.of(false),
        ],
      });

      return new EditorView({
        state,
        parent: annotatedContainer,
      });
    }

    // Update annotated output
    function updateAnnotatedOutput() {
      if (!annotatedPaneOpen || !annotatedEditor) return;

      const code = editor.state.doc.toString();
      try {
        const annotated = window.SvgPathExtended.compileAnnotated(code);
        annotatedEditor.dispatch({
          changes: {
            from: 0,
            to: annotatedEditor.state.doc.length,
            insert: annotated,
          },
        });
      } catch (e) {
        annotatedEditor.dispatch({
          changes: {
            from: 0,
            to: annotatedEditor.state.doc.length,
            insert: `// Error: ${e.message}`,
          },
        });
      }
    }

    // Toggle annotated pane
    function toggleAnnotatedPane() {
      annotatedPaneOpen = !annotatedPaneOpen;
      annotatedPane.classList.toggle('open', annotatedPaneOpen);
      annotatedToggle.classList.toggle('active', annotatedPaneOpen);

      if (annotatedPaneOpen) {
        if (!annotatedEditor) {
          annotatedEditor = createAnnotatedEditor();
        }
        updateAnnotatedOutput();
      }
    }

    // Update preview
    function updatePreview() {
      const code = editor.state.doc.toString();

      try {
        const pathData = window.SvgPathExtended.compile(code);
        previewPath.setAttribute('d', pathData);
        hideError();
      } catch (e) {
        showError(e.message);
      }

      updateSvgStyles();
    }

    function debouncedUpdate() {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => {
        updatePreview();
        updateAnnotatedOutput();
      }, 150);
    }

    // Update SVG styles
    function updateSvgStyles() {
      const width = parseInt(widthInput.value) || 200;
      const height = parseInt(heightInput.value) || 200;

      preview.setAttribute('width', width);
      preview.setAttribute('height', height);
      preview.setAttribute('viewBox', `0 0 ${width} ${height}`);

      previewPath.setAttribute('stroke', strokeInput.value);
      previewPath.setAttribute('stroke-width', strokeWidthSelect.value);

      if (fillEnabledInput.checked) {
        previewPath.setAttribute('fill', fillInput.value);
      } else {
        previewPath.setAttribute('fill', 'none');
      }

      previewBg.setAttribute('fill', bgInput.value);

      // Update grid
      const gridSize = parseInt(gridSizeSelect.value) || 20;
      const gridColor = gridColorInput.value;
      const gridEnabled = gridEnabledInput.checked;

      gridPattern.setAttribute('width', gridSize);
      gridPattern.setAttribute('height', gridSize);
      gridPath.setAttribute('d', `M ${gridSize} 0 L 0 0 0 ${gridSize}`);
      gridPath.setAttribute('stroke', gridColor);
      previewGrid.style.display = gridEnabled ? 'block' : 'none';
    }

    // Error handling
    function showError(message) {
      errorPanel.textContent = message;
      errorPanel.classList.add('visible');
    }

    function hideError() {
      errorPanel.classList.remove('visible');
    }

    // URL state management
    function encodeState() {
      const state = {
        code: editor.state.doc.toString(),
        w: parseInt(widthInput.value),
        h: parseInt(heightInput.value),
        s: strokeInput.value,
        f: fillEnabledInput.checked ? fillInput.value : null,
        bg: bgInput.value,
        sw: strokeWidthSelect.value,
        ge: gridEnabledInput.checked,
        gc: gridColorInput.value,
        gs: gridSizeSelect.value,
        ao: annotatedPaneOpen,
      };
      return btoa(encodeURIComponent(JSON.stringify(state)));
    }

    function decodeState(hash) {
      try {
        const json = decodeURIComponent(atob(hash));
        return JSON.parse(json);
      } catch (e) {
        return null;
      }
    }

    function loadFromURL() {
      const hash = location.hash.slice(1);
      if (!hash) return null;

      const state = decodeState(hash);
      if (!state) return null;

      if (state.w) widthInput.value = state.w;
      if (state.h) heightInput.value = state.h;
      if (state.s) strokeInput.value = state.s;
      if (state.f) {
        fillEnabledInput.checked = true;
        fillInput.value = state.f;
        fillInput.disabled = false;
      }
      if (state.bg) bgInput.value = state.bg;
      if (state.sw) strokeWidthSelect.value = state.sw;
      if (state.ge !== undefined) gridEnabledInput.checked = state.ge;
      if (state.gc) gridColorInput.value = state.gc;
      if (state.gs) gridSizeSelect.value = state.gs;

      // Restore annotated pane state
      if (state.ao) {
        annotatedPaneOpen = true;
        annotatedPane.classList.add('open');
        annotatedToggle.classList.add('active');
      }

      return state.code || null;
    }

    // Copy URL
    function copyURL() {
      const url = location.origin + location.pathname + '#' + encodeState();
      navigator.clipboard.writeText(url).then(() => {
        copyFeedback.classList.add('visible');
        setTimeout(() => copyFeedback.classList.remove('visible'), 2000);
      });
    }

    // Load example
    function loadExample(name) {
      if (examples[name]) {
        editor.dispatch({
          changes: {
            from: 0,
            to: editor.state.doc.length,
            insert: examples[name],
          },
        });
        updatePreview();
        updateAnnotatedOutput();
      }
    }

    // Event listeners
    examplesSelect.addEventListener('change', (e) => {
      if (e.target.value) {
        loadExample(e.target.value);
        e.target.value = '';
      }
    });

    widthInput.addEventListener('input', updateSvgStyles);
    heightInput.addEventListener('input', updateSvgStyles);
    strokeInput.addEventListener('input', updateSvgStyles);
    fillEnabledInput.addEventListener('change', (e) => {
      fillInput.disabled = !e.target.checked;
      updateSvgStyles();
    });
    fillInput.addEventListener('input', updateSvgStyles);
    bgInput.addEventListener('input', updateSvgStyles);
    gridEnabledInput.addEventListener('change', updateSvgStyles);
    gridColorInput.addEventListener('input', updateSvgStyles);
    gridSizeSelect.addEventListener('change', updateSvgStyles);
    strokeWidthSelect.addEventListener('change', updateSvgStyles);
    copyUrlBtn.addEventListener('click', copyURL);

    // Annotated pane toggle
    annotatedToggle.addEventListener('click', toggleAnnotatedPane);

    // Copy annotated output
    copyAnnotatedBtn.addEventListener('click', () => {
      if (annotatedEditor) {
        const annotated = annotatedEditor.state.doc.toString();
        navigator.clipboard.writeText(annotated).then(() => {
          copyAnnotatedBtn.textContent = 'Copied!';
          copyAnnotatedBtn.classList.add('copied');
          setTimeout(() => {
            copyAnnotatedBtn.textContent = 'Copy';
            copyAnnotatedBtn.classList.remove('copied');
          }, 1500);
        });
      }
    });

    // Docs panel
    docsBtn.addEventListener('click', () => {
      docsPanel.classList.add('open');
    });

    docsClose.addEventListener('click', () => {
      docsPanel.classList.remove('open');
    });

    docsTabs.forEach(tab => {
      tab.addEventListener('click', () => {
        const tabName = tab.dataset.tab;
        docsTabs.forEach(t => t.classList.remove('active'));
        docSections.forEach(s => s.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(`doc-${tabName}`).classList.add('active');
      });
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && docsPanel.classList.contains('open')) {
        docsPanel.classList.remove('open');
      }
    });

    // Copy buttons
    function showCopied(btn) {
      btn.textContent = 'Copied!';
      btn.classList.add('copied');
      setTimeout(() => {
        btn.textContent = btn === copyCodeBtn ? 'Copy Code' : 'Copy SVG';
        btn.classList.remove('copied');
      }, 1500);
    }

    copyCodeBtn.addEventListener('click', () => {
      const code = editor.state.doc.toString();
      navigator.clipboard.writeText(code).then(() => showCopied(copyCodeBtn));
    });

    copySvgBtn.addEventListener('click', () => {
      // Generate clean SVG with just the path
      const width = preview.getAttribute('width');
      const height = preview.getAttribute('height');
      const viewBox = preview.getAttribute('viewBox');
      const pathD = previewPath.getAttribute('d') || '';

      const cleanSvg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="${viewBox}" width="${width}" height="${height}">
  <path d="${pathD}"/>
</svg>`;

      navigator.clipboard.writeText(cleanSvg).then(() => showCopied(copySvgBtn));
    });

    // Wait for library to load, then initialize
    function waitForLibrary(callback, maxWait = 5000) {
      const start = Date.now();
      function check() {
        if (window.SvgPathExtended) {
          callback();
        } else if (Date.now() - start < maxWait) {
          setTimeout(check, 50);
        } else {
          showError('Failed to load svg-path-extended library');
        }
      }
      check();
    }

    // Initialize
    waitForLibrary(() => {
      const initialCode = loadFromURL() || defaultCode;
      editor = createEditor(initialCode);
      updatePreview();

      // If annotated pane was open from URL state, create the editor and update
      if (annotatedPaneOpen) {
        annotatedEditor = createAnnotatedEditor();
        updateAnnotatedOutput();
      }
    });
  </script>

  <!-- svg-path-extended library -->
  <script src="../dist/index.global.js"></script>
</body>
</html>
